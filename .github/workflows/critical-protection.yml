name: üî• CRITICAL BOT FILES PROTECTION

on:
  push:
    branches: [main]
    paths:
      - 'database.json'
      - 'index.js'
      - 'handler.js'
      - 'settings.js'
      - 'scurity.js'
  pull_request:
    branches: [main]
    paths:
      - 'database.json'
      - 'index.js'
      - 'handler.js'
      - 'settings.js'
      - 'scurity.js'

jobs:
  lockdown:
    runs-on: ubuntu-latest
    name: üîê Verify Critical File Changes
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üö® Detect changed files
        id: changed-files
        run: |
          echo "=== Changed Files Detection ==="
          files=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "")
          
          if [ -z "$files" ]; then
            echo "No previous commit to compare (first commit?)"
            echo "has_critical_changes=false" >> $GITHUB_OUTPUT
          else
            echo "All changed files:"
            echo "$files"
            echo ""
            
            # Critical files list
            critical_files=("database.json" "index.js" "handler.js" "settings.js" "scurity.js")
            critical_detected=false
            
            for changed in $files; do
              for critical in "${critical_files[@]}"; do
                if [[ "$changed" == "$critical" ]]; then
                  echo "‚ö†Ô∏è  CRITICAL FILE DETECTED: $changed"
                  critical_detected=true
                fi
              done
            done
            
            if [ "$critical_detected" = true ]; then
              echo "critical_changed=true" >> $GITHUB_OUTPUT
            else
              echo "critical_changed=false" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: üëë STRICT AUTHORIZATION CHECK
        if: steps.changed-files.outputs.critical_changed == 'true'
        run: |
          echo "=== üîê AUTHORIZATION CHECK ==="
          
          # ALLOWED USERS (ONLY YOU)
          ALLOWED_USERS=("Rimmn")
          CURRENT_USER="${{ github.actor }}"
          
          echo "Current User: $CURRENT_USER"
          echo "Allowed Users: ${ALLOWED_USERS[@]}"
          echo ""
          
          # Check if user is allowed
          IS_ALLOWED=false
          for allowed in "${ALLOWED_USERS[@]}"; do
            if [ "$CURRENT_USER" = "$allowed" ]; then
              IS_ALLOWED=true
              break
            fi
          done
          
          if [ "$IS_ALLOWED" = false ]; then
            echo "‚ùå‚ùå‚ùå ACCESS DENIED! ‚ùå‚ùå‚ùå"
            echo ""
            echo "=========================================="
            echo "üö´ UNAUTHORIZED CRITICAL FILE MODIFICATION"
            echo "=========================================="
            echo "User '$CURRENT_USER' tried to modify:"
            
            # List critical files changed
            critical_files=("database.json" "index.js" "handler.js" "settings.js" "scurity.js")
            for changed in $(git diff --name-only HEAD^ HEAD 2>/dev/null); do
              for critical in "${critical_files[@]}"; do
                if [[ "$changed" == "$critical" ]]; then
                  echo "- $changed"
                fi
              done
            done
            
            echo ""
            echo "‚ö†Ô∏è  These files can only be modified by:"
            echo "    ${ALLOWED_USERS[@]}"
            echo "=========================================="
            
            # Fail the workflow
            exit 1
            
          else
            echo "‚úÖ AUTHORIZED! User '$CURRENT_USER' is allowed."
            echo "Proceeding with changes..."
          fi
          
      - name: ‚úÖ AUTHORIZATION SUCCESS
        if: steps.changed-files.outputs.critical_changed == 'true'
        run: |
          echo "=========================================="
          echo "üéâ AUTHORIZED CRITICAL FILE MODIFICATION"
          echo "=========================================="
          echo "User: ${{ github.actor }}"
          echo "Status: VERIFIED OWNER"
          echo "Time: $(date)"
          echo ""
          echo "Modified critical files:"
          for file in $(git diff --name-only HEAD^ HEAD 2>/dev/null); do
            case $file in
              database.json|index.js|handler.js|settings.js|scurity.js)
                echo "- $file"
                ;;
            esac
          done
          echo "=========================================="
          
      - name: üìù FILE VALIDATION
        if: steps.changed-files.outputs.critical_changed == 'true'
        run: |
          echo "=== üìã Validating file formats ==="
          
          # Validate JSON files
          for file in database.json; do
            if [ -f "$file" ] && git diff --name-only HEAD^ HEAD 2>/dev/null | grep -q "^$file$"; then
              echo "Checking $file..."
              if python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "  ‚úÖ $file - Valid JSON"
              else
                echo "  ‚ùå $file - Invalid JSON format!"
                exit 1
              fi
            fi
          done
          
      - name: üèÅ WORKFLOW COMPLETE
        run: |
          echo "=========================================="
          echo "üîí CRITICAL FILES PROTECTION SYSTEM"
          echo "‚úÖ All checks completed"
          echo "=========================================="
