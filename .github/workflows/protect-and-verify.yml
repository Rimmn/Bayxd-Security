name: üî• ULTIMATE BOT PROTECTION

on:
  push:
    branches: [main]
    paths:
      - 'database.json'
      - 'index.js'
      - 'handler.js'
      - 'settings.js'
      - 'scurity.js'
      - 'control/**'
      - 'plugins/**'
  pull_request:
    branches: [main]
    paths:
      - 'database.json'
      - 'index.js'
      - 'handler.js'
      - 'settings.js'
      - 'scurity.js'
      - 'control/**'
      - 'plugins/**'

jobs:
  lockdown:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: üö® ALERT - CRITICAL FILES DETECTED
      run: |
        echo "=============================================="
        echo "üî• BOT CORE FILES PROTECTION ACTIVATED!"
        echo "üö´ Critical files cannot be modified by others"
        echo "=============================================="
        echo "User: ${{ github.actor }}"
        echo "Event: ${{ github.event_name }}"
        echo "Time: $(date)"
        echo "=============================================="
    
    - name: üì• CHECKOUT WITH DEEP HISTORY
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: üîç IDENTIFY MODIFIED FILES
      id: files_check
      run: |
        echo "=== SCANNING MODIFIED FILES ==="
        
        # Get list of changed files
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "")
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No files changed or first commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Critical files list
          CRITICAL_FILES=(
            "index.js"
            "handler.js" 
            "settings.js"
            "scurity.js"
            "database.json"
            "control/"
            "plugins/"
          )
          
          CRITICAL_CHANGED=false
          for file in $CHANGED_FILES; do
            for critical in "${CRITICAL_FILES[@]}"; do
              if [[ $file == $critical* ]]; then
                echo "üö® CRITICAL FILE MODIFIED: $file"
                CRITICAL_CHANGED=true
              fi
            done
          done
          
          if [ "$CRITICAL_CHANGED" = true ]; then
            echo "critical_changed=true" >> $GITHUB_OUTPUT
          else
            echo "critical_changed=false" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: üëë OWNER VERIFICATION SYSTEM
      if: steps.files_check.outputs.critical_changed == 'true'
      run: |
        echo "=== üîê OWNER VERIFICATION ==="
        
        # ONLY THESE USERS CAN MODIFY CRITICAL FILES
        OWNER_USERS=("Rimmn")  # YOUR GITHUB USERNAME
        
        CURRENT_USER="${{ github.actor }}"
        echo "Current User: $CURRENT_USER"
        echo "Allowed Owners: ${OWNER_USERS[@]}"
        echo ""
        
        # Check if user is owner
        IS_OWNER=false
        for owner in "${OWNER_USERS[@]}"; do
          if [ "$CURRENT_USER" = "$owner" ]; then
            IS_OWNER=true
            break
          fi
        done
        
        if [ "$IS_OWNER" = false ]; then
          echo "‚ùå‚ùå‚ùå BLOCKED! ‚ùå‚ùå‚ùå"
          echo ""
          echo "=================================================="
          echo "üö´ UNAUTHORIZED ACCESS ATTEMPT!"
          echo "=================================================="
          echo "User '$CURRENT_USER' tried to modify critical bot files!"
          echo ""
          echo "CRITICAL FILES PROTECTED:"
          echo "- index.js (Main Bot File)"
          echo "- handler.js (Command Handler)"
          echo "- settings.js (Bot Configuration)"
          echo "- scurity.js (Security System)"
          echo "- database.json (User Database)"
          echo "- control/ (Core Functions)"
          echo "- plugins/ (Bot Plugins)"
          echo ""
          echo "‚ö†Ô∏è  Only these users can modify: ${OWNER_USERS[@]}"
          echo "=================================================="
          
          # FAIL THE WORKFLOW
          exit 1
        else
          echo "‚úÖ VERIFIED! User $CURRENT_USER is authorized owner"
          echo "Proceeding with changes..."
        fi
    
    - name: üìù FILE CONTENT VALIDATION
      if: steps.files_check.outputs.critical_changed == 'true'
      run: |
        echo "=== üìã CONTENT VALIDATION ==="
        
        # Check JavaScript syntax for .js files
        for file in $(git diff --name-only HEAD^ HEAD | grep '\.js$'); do
          if [ -f "$file" ]; then
            echo "Validating $file..."
            
            # Basic syntax check
            if node -c "$file" 2>/dev/null; then
              echo "  ‚úÖ $file - JavaScript syntax OK"
            else
              echo "  ‚ùå $file - JavaScript syntax ERROR!"
              echo "    This file has syntax errors!"
              exit 1
            fi
          fi
        done
        
        # Check JSON files
        for file in $(git diff --name-only HEAD^ HEAD | grep '\.json$'); do
          if [ -f "$file" ]; then
            echo "Validating $file..."
            
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "  ‚úÖ $file - JSON format OK"
            else
              echo "  ‚ùå $file - JSON format INVALID!"
              exit 1
            fi
          fi
        done
    
    - name: ‚úÖ FINAL APPROVAL
      if: steps.files_check.outputs.critical_changed == 'true'
      run: |
        echo "=========================================="
        echo "üéâ CRITICAL FILE CHANGES APPROVED!"
        echo "=========================================="
        echo "User: ${{ github.actor }}"
        echo "Status: Authorized Owner"
        echo "Time: $(date)"
        echo ""
        echo "Modified files:"
        git diff --name-only HEAD^ HEAD
        echo "=========================================="
    
    - name: üìß NOTIFY ON UNAUTHORIZED ACCESS
      if: failure()
      run: |
        echo "=== üì§ SENDING SECURITY ALERT ==="
        echo "Security breach detected!"
        echo "User: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        echo "Time: $(date)"
        echo ""
        echo "To get notifications, set up:"
        echo "1. Go to Repository Settings"
        echo "2. Click 'Secrets and variables' > 'Actions'"
        echo "3. Add DISCORD_WEBHOOK or TELEGRAM_BOT_TOKEN"
        
    - name: üèÅ WORKFLOW COMPLETE
      run: |
        echo "=========================================="
        echo "üîí BOT PROTECTION SYSTEM ACTIVE"
        echo "‚úÖ All security checks passed"
        echo "=========================================="
