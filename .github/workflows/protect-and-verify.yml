name: üîê ULTIMATE BOT SECURITY

on:
  push:
    branches: [ main ]
    paths:
      # ==================== CORE BOT FILES ====================
      - 'index.js'                    # Main bot entry point
      - 'handler.js'                  # Command handler
      - 'scurity.js'                  # GitHub token & security config
      - 'settings.js'                 # Bot settings & owner data
      - 'config.js'                   # Message config
      - 'function.js'                 # Utility functions
      - 'database.js'                 # Database operations
      
      # ==================== FEATURE MODULES ====================
      - 'autosholat.js'               # Auto sholat scheduler
      - 'uploader.js'                 # File uploader
      - 'webp.js'                     # Sticker converter
      - 'game.js'                     # Game system
      - 'plugins.js'                  # Plugin loader
      
      # ==================== DATABASE FILES ====================
      - 'database.json'               # User whitelist database
      - 'data/owner.json'             # Bot owners list
      - 'data/sewa.json'              # Premium users
      - 'data/premiumV1.json'         # Group premium v1
      - 'data/premiumV2.json'         # Group premium v2
      - 'data/ban.json'               # Banned users
      - 'data/list.json'              # Custom responses
      - 'data/database.db'            # SQLite database
      
      # ==================== CONFIGURATION ====================
      - 'package.json'                # Dependencies & bot info
      - 'README.md'                   # Bot documentation

  pull_request:
    branches: [ main ]
    paths:
      - 'index.js'
      - 'handler.js'
      - 'scurity.js'
      - 'settings.js'
      - 'config.js'
      - 'database.json'
      - 'data/owner.json'
      - 'data/sewa.json'
      - 'data/database.db'

jobs:
  security_verification:
    name: üîç Verify File Modifications
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      
    steps:
      # ==================== STEP 1: CHECKOUT ====================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # ==================== STEP 2: DETECT CHANGES ====================
      - name: üìã Detect Modified Files
        id: detect_files
        run: |
          echo "üîç SCANNING FOR MODIFIED FILES..."
          echo "=========================================="
          
          # Get list of changed files
          if git rev-parse HEAD^ > /dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
            echo "üìÑ Changed files detected:"
            echo "$CHANGED_FILES" | while read -r file; do
              echo "   ‚Ä¢ $file"
            done
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è  First commit or no previous commit"
            CHANGED_FILES=""
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          echo "=========================================="
          
      # ==================== STEP 3: CRITICAL FILE CHECK ====================
      - name: üö® Identify Critical Files
        id: critical_check
        if: steps.detect_files.outputs.has_changes == 'true'
        run: |
          echo "üö® CHECKING FOR CRITICAL FILE MODIFICATIONS..."
          echo "=========================================="
          
          # Define critical files (HIGH RISK)
          CRITICAL_FILES=(
            "scurity.js"      # Contains GitHub tokens
            "database.json"   # User database
            "data/owner.json" # Owner list
            "data/sewa.json"  # Premium data
            "settings.js"     # Bot configuration
            "index.js"        # Main bot file
          )
          
          CRITICAL_DETECTED=false
          CRITICAL_LIST=""
          
          for file in $CHANGED_FILES; do
            for critical in "${CRITICAL_FILES[@]}"; do
              if [[ "$file" == "$critical" ]]; then
                echo "‚ö†Ô∏è  CRITICAL FILE DETECTED: $file"
                CRITICAL_DETECTED=true
                CRITICAL_LIST+="$file"$'\n'
              fi
            done
          done
          
          if [ "$CRITICAL_DETECTED" = true ]; then
            echo "critical_detected=true" >> $GITHUB_OUTPUT
            echo "critical_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CRITICAL_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No critical files modified"
            echo "critical_detected=false" >> $GITHUB_OUTPUT
          fi
          
          echo "=========================================="
          
      # ==================== STEP 4: STRICT AUTHORIZATION ====================
      - name: üîê Strict Owner Verification
        id: auth_check
        if: steps.critical_check.outputs.critical_detected == 'true'
        run: |
          echo "üîê STRICT AUTHORIZATION VERIFICATION"
          echo "=========================================="
          
          # ===== CONFIGURATION =====
          # Hanya user ini yang boleh modifikasi file kritis
          ALLOWED_USERS=("Rimmn")  # <<< GANTI DENGAN USERNAME GITHUB KAMU
          
          CURRENT_USER="${{ github.actor }}"
          CURRENT_EMAIL="${{ github.event.head_commit.author.email }}"
          
          echo "üë§ Current User: $CURRENT_USER"
          echo "üìß Current Email: $CURRENT_EMAIL"
          echo "‚úÖ Allowed Users: ${ALLOWED_USERS[@]}"
          echo ""
          
          # ===== VERIFICATION LOGIC =====
          IS_AUTHORIZED=false
          
          # Check username
          for user in "${ALLOWED_USERS[@]}"; do
            if [ "$CURRENT_USER" = "$user" ]; then
              IS_AUTHORIZED=true
              echo "‚úÖ Username verification PASSED"
              break
            fi
          done
          
          # ===== AUTHORIZATION RESULT =====
          if [ "$IS_AUTHORIZED" = false ]; then
            echo ""
            echo "‚ùå‚ùå‚ùå SECURITY BREACH DETECTED! ‚ùå‚ùå‚ùå"
            echo "=========================================="
            echo "üö´ UNAUTHORIZED ACCESS ATTEMPT"
            echo "=========================================="
            echo "User: $CURRENT_USER"
            echo "Email: $CURRENT_EMAIL"
            echo ""
            echo "üìÅ ATTEMPTED TO MODIFY CRITICAL FILES:"
            echo "${{ steps.critical_check.outputs.critical_files }}"
            echo ""
            echo "üîí SECURITY POLICY:"
            echo "These files contain sensitive data and can only"
            echo "be modified by authorized users:"
            echo "  ‚Ä¢ ${ALLOWED_USERS[@]}"
            echo ""
            echo "‚ö†Ô∏è  RECOMMENDED ACTIONS:"
            echo "1. Review this change immediately"
            echo "2. Check for compromised accounts"
            echo "3. Rotate GitHub tokens if exposed"
            echo "=========================================="
            
            # Save detailed report
            echo "::error title=SECURITY VIOLATION::User '$CURRENT_USER' attempted unauthorized modification of critical files"
            echo "::endgroup::"
            
            exit 1  # BLOCK THE COMMIT
            
          else
            echo ""
            echo "‚úÖ‚úÖ‚úÖ AUTHORIZATION GRANTED ‚úÖ‚úÖ‚úÖ"
            echo "=========================================="
            echo "User '$CURRENT_USER' is authorized"
            echo "Proceeding with changes..."
            echo "=========================================="
          fi
          
      # ==================== STEP 5: FILE VALIDATION ====================
      - name: üìù Validate File Integrity
        if: steps.critical_check.outputs.critical_detected == 'true'
        run: |
          echo "üìù VALIDATING FILE INTEGRITY..."
          echo "=========================================="
          
          # Check JSON files syntax
          for file in $CHANGED_FILES; do
            if [[ "$file" == *.json ]]; then
              echo "üîç Validating JSON: $file"
              if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚ùå INVALID JSON SYNTAX: $file"
                echo "::error file=$file::Invalid JSON syntax detected"
                exit 1
              else
                echo "‚úÖ Valid JSON: $file"
              fi
            fi
          done
          
          # Check JavaScript syntax
          for file in $CHANGED_FILES; do
            if [[ "$file" == *.js ]]; then
              echo "üîç Validating JavaScript: $file"
              if ! node -c "$file" 2>/dev/null; then
                echo "‚ùå JAVASCRIPT SYNTAX ERROR: $file"
                echo "::error file=$file::JavaScript syntax error detected"
                exit 1
              else
                echo "‚úÖ Valid JavaScript: $file"
              fi
            fi
          done
          
          echo "‚úÖ All file validations passed"
          echo "=========================================="
          
      # ==================== STEP 6: SECURITY AUDIT LOG ====================
      - name: üìä Generate Security Report
        if: always()
        run: |
          echo "üìä SECURITY AUDIT REPORT"
          echo "=========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "User: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ STATUS: SECURITY CHECKS PASSED"
            echo "‚úÖ User authorization: VERIFIED"
            echo "‚úÖ File integrity: VALID"
            echo "‚úÖ Security policy: ENFORCED"
          else
            echo "‚ùå STATUS: SECURITY CHECK FAILED"
            echo "‚ùå Action: COMMIT BLOCKED"
            echo "‚ùå Reason: Unauthorized modification attempt"
          fi
          
          echo "=========================================="
          echo "üîê PROTECTED FILES SUMMARY:"
          echo "‚Ä¢ Core Bot Files: 7 files"
          echo "‚Ä¢ Feature Modules: 5 files"
          echo "‚Ä¢ Database Files: 8 files"
          echo "‚Ä¢ Configuration: 2 files"
          echo "‚Ä¢ TOTAL: 22 protected files"
          echo "=========================================="
          
      # ==================== STEP 7: FINAL SUCCESS ====================
      - name: üéâ Security Verification Complete
        if: success()
        run: |
          echo "=========================================="
          echo "üéâ SECURITY VERIFICATION COMPLETE"
          echo "=========================================="
          echo "‚úÖ All security checks passed"
          echo "‚úÖ User identity verified"
          echo "‚úÖ File integrity validated"
          echo "‚úÖ Critical files protected"
          echo ""
          echo "üë§ Authorized User: ${{ github.actor }}"
          echo "üìÖ Timestamp: $(date)"
          echo "üè∑Ô∏è  Status: APPROVED FOR MERGE"
          echo "=========================================="

# ==================== WORKFLOW CONFIGURATION ====================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
