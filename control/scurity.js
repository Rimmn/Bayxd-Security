/*  Security GitHub - Safe Version with Environment Variables  Repository: Rimmn/Bayxd-Security*/import axios from 'axios';import config from '/home/container/src/config/env.js';// === CACHE SYSTEM ===let cacheData = null;let lastFetch = 0;let isFetching = false;const fetchQueue = [];// === VALIDATE CONFIG ===function validateConfig() {  console.log('üîß Config Validation:');  console.log('   Repository:', config.github.owner + '/' + config.github.repo);  console.log('   Data File:', config.github.file);  console.log('   Cache Time:', config.github.cacheTime, 'ms');  console.log('   Backup:', config.github.backup ? '‚úÖ ON' : '‚ùå OFF');    if (!config.github.token) {    console.error('‚ùå ERROR: GITHUB_TOKEN tidak ditemukan!');    console.error('üí° Tambahkan Environment Variable: GITHUB_TOKEN');    return false;  }    if (config.github.token.length < 40) {    console.error('‚ùå ERROR: Token tidak valid!');    return false;  }    console.log('‚úÖ Config valid');  return true;}// === GET GITHUB API URL ===function getGitHubUrl() {  return `https://api.github.com/repos/${config.github.owner}/${config.github.repo}/contents/${config.github.file}`;}// === FETCH FROM GITHUB ===async function fetchFromGitHub() {  if (!validateConfig()) {    return { nomor: [] };  }    try {    console.log('üì• Fetching from GitHub...');    const apiUrl = getGitHubUrl();        const response = await axios.get(apiUrl, {      headers: {        Authorization: `token ${config.github.token}`,        Accept: 'application/vnd.github.v3+json',        'User-Agent': 'JARR-Bot-Security'      },      timeout: 30000,      validateStatus: function (status) {        return status >= 200 && status < 300;      }    });        const content = Buffer.from(response.data.content, 'base64').toString('utf8');    let data;        try {      data = JSON.parse(content);    } catch (parseError) {      console.error('‚ùå Error parsing JSON');      data = { nomor: [] };    }        if (!data.nomor || !Array.isArray(data.nomor)) {      console.warn('‚ö†Ô∏è Invalid data structure, resetting to empty array');      data.nomor = [];    }        console.log(`‚úÖ Fetched ${data.nomor.length} items from GitHub`);    return data;      } catch (error) {    handleGitHubError(error);    return { nomor: [] };  }}// === ERROR HANDLER ===function handleGitHubError(error) {  console.error('‚ùå GitHub API Error:');    if (error.response) {    console.error(`   Status: ${error.response.status}`);        switch (error.response.status) {      case 401:        console.error('   ‚ö†Ô∏è Token invalid or expired');        break;      case 403:        console.error('   ‚ö†Ô∏è Rate limit exceeded');        break;      case 404:        console.error(`   ‚ö†Ô∏è File not found: ${config.github.file}`);        break;    }  } else if (error.request) {    console.error('   Network Error - No response from GitHub');  } else {    console.error('   Error:', error.message);  }}// === MAIN FUNCTION ===export async function scurityDB(forceRefresh = false) {  try {    const now = Date.now();        if (!forceRefresh && cacheData && (now - lastFetch < config.github.cacheTime)) {      return cacheData;    }        const data = await fetchFromGitHub();        cacheData = data;    lastFetch = now;        return data;      } catch (error) {    console.error('‚ùå Error in scurityDB');    return { nomor: [] };  }}// === UPDATE DATABASE ===export async function upNumber(newData) {  try {    if (!validateConfig()) {      throw new Error('Invalid configuration');    }        if (!newData || typeof newData !== 'object') {      throw new Error('Invalid data format');    }        if (!newData.nomor || !Array.isArray(newData.nomor)) {      newData.nomor = [];    }        console.log('üì§ Updating GitHub database...');    console.log(`   Items: ${newData.nomor.length}`);        const apiUrl = getGitHubUrl();        const currentFile = await axios.get(apiUrl, {      headers: {        Authorization: `token ${config.github.token}`,        Accept: 'application/vnd.github.v3+json'      }    });        const content = JSON.stringify(newData, null, 2);    const encodedContent = Buffer.from(content).toString('base64');        const updateData = {      message: `Database update - ${new Date().toLocaleString()}`,      content: encodedContent,      sha: currentFile.data.sha,      committer: {        name: 'JARR Bot',        email: 'bot@jarr.local'      }    };        await axios.put(apiUrl, updateData, {      headers: {        Authorization: `token ${config.github.token}`,        'Content-Type': 'application/json',        Accept: 'application/vnd.github.v3+json'      }    });        cacheData = newData;    lastFetch = Date.now();        console.log('‚úÖ Database updated successfully');    return true;      } catch (error) {    console.error('‚ùå Failed to update database');    handleGitHubError(error);    throw error;  }}// === UTILITY FUNCTIONS ===export function clearCache() {  cacheData = null;  lastFetch = 0;  console.log('üóëÔ∏è Cache cleared');}export function getCacheInfo() {  return {    hasCache: cacheData !== null,    lastFetch: lastFetch,    age: lastFetch ? Date.now() - lastFetch : null,    itemCount: cacheData?.nomor?.length || 0,    cacheTime: config.github.cacheTime,    config: {      owner: config.github.owner,      repo: config.github.repo,      file: config.github.file,      backup: config.github.backup    }  };}export async function testConnection() {  console.log('üß™ Testing GitHub connection...');    if (!validateConfig()) {    return false;  }    try {    const testUrl = `https://api.github.com/repos/${config.github.owner}/${config.github.repo}`;    const response = await axios.get(testUrl, {      headers: {        Authorization: `token ${config.github.token}`,        Accept: 'application/vnd.github.v3+json'      },      timeout: 10000    });        console.log('‚úÖ Connection successful!');    console.log(`   Repository: ${response.data.full_name}`);    console.log(`   Visibility: ${response.data.private ? 'Private' : 'Public'}`);    console.log(`   Last push: ${response.data.pushed_at}`);        return true;  } catch (error) {    console.error('‚ùå Connection test failed');    handleGitHubError(error);    return false;  }}// === INITIALIZE ===console.log('üîê Security System Initialized');console.log('   Using config from: src/config/env.js');if (config.github.backup) {  console.log('üîÑ GitHub backup enabled');}export default {  scurityDB,  upNumber,  clearCache,  getCacheInfo,  testConnection};